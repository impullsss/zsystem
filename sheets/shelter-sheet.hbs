<form class="{{cssClass}}" autocomplete="off">
    <header class="sheet-header" style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <img class="profile-img" src="{{actor.img}}" data-edit="img" height="80" width="80" style="border:1px solid #333;"/>
        <h1 style="flex:1; margin:0;"><input name="name" type="text" value="{{actor.name}}" style="width:100%;"/></h1>
        <button type="button" class="end-day-btn" style="background:#8b0000; color:white; width:auto; height:40px;">
            <i class="fas fa-moon"></i> Завершить день
        </button>
        <button type="button" class="end-session-btn" style="background:#1565c0; color:white; width:auto; height:40px; margin-left:5px;">
    <i class="fas fa-save"></i> Опыт (Сессия)
</button>
    </header>

    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="main">Статус</a>
        <a class="item" data-tab="upgrades">Постройки</a>
        <a class="item" data-tab="projects">Проекты</a>
        <a class="item" data-tab="facilities">Инфраструктура</a>
        <a class="item" data-tab="residents">Жители ({{populationCount}})</a>
        <a class="item" data-tab="inventory">Склад</a>
    </nav>

    <section class="sheet-body">
        <!-- MAIN TAB (Stats only) -->
        <div class="tab main" data-group="primary" data-tab="main">
            <div class="shelter-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                
                <!-- RESOURCES -->
                <div class="panel" style="border:1px solid #777; padding:5px; background:rgba(0,0,0,0.05);">
                    <h3 style="border-bottom:1px solid #ccc;">Ресурсы</h3>
                    <div class="resource-row flexrow" style="align-items:center;">
                        <label style="flex:1;">Еда</label>
                        <input type="number" name="system.resources.food.value" value="{{system.resources.food.value}}" style="width:50px;"/>
                    </div>
                    <div class="resource-row flexrow" style="align-items:center;">
                        <label style="flex:1;">Топливо</label>
                        <input type="number" name="system.resources.fuel.value" value="{{system.resources.fuel.value}}" style="width:50px;"/>
                    </div>
                    <div class="resource-row flexrow" style="align-items:center;">
                        <label style="flex:1;">Детали</label>
                        <input type="number" name="system.resources.parts.value" value="{{system.resources.parts.value}}" style="width:50px;"/>
                    </div>
                    <div class="resource-row flexrow" style="align-items:center;">
                        <label style="flex:1;">Антибиотики</label>
                        <input type="number" name="system.resources.antibiotics.value" value="{{system.resources.antibiotics.value}}" style="width:50px;"/>
                    </div>
                </div>

                <!-- STATS -->
                <div class="panel" style="border:1px solid #777; padding:5px; background:rgba(0,0,0,0.05);">
                    <h3 style="border-bottom:1px solid #ccc;">Статус</h3>
                    <div class="resource-row flexrow">
                        <label style="flex:1;">Население</label>
                        <input type="number" name="system.population.value" value="{{populationCount}}" disabled style="width:50px;"/>
                    </div>
                    <!-- ЗАЩИТА -->
                    <div class="resource-row flexrow" style="align-items:center;">
                        <label style="flex:1; font-weight:bold;">ЗАЩИТА</label>
                        <input type="number" name="system.resources.defense.value" value="{{system.resources.defense.value}}" disabled style="width:50px; background:#ddd; font-weight:bold;"/>
                    </div>
                    <div class="resource-row flexrow">
                        <label style="flex:1;">Мораль</label>
                        <input type="number" name="system.morale.value" value="{{system.morale.value}}" style="width:50px;"/>
                    </div>
                    <div class="resource-row flexrow">
                        <label style="flex:1;">Тренд</label>
                        <input type="number" name="system.morale.trend" value="{{system.morale.trend}}" style="width:50px;"/>
                    </div>
                </div>
            </div>
        </div>

        <!-- UPGRADES TAB -->
        <div class="tab upgrades" data-group="primary" data-tab="upgrades">
            <div class="flexrow" style="align-items:center; justify-content:space-between; background:#ddd; padding:2px;">
                <h3>Строительство</h3>
                <a class="item-create" data-type="upgrade" title="Постройка"><i class="fas fa-home"></i> Добавить</a>
            </div>
            <ol class="item-list">
                {{#each activeUpgrades as |item|}}
                    {{> "systems/zsystem/sheets/partials/project-card.hbs" item=item type="upgrade"}}
                {{/each}}
            </ol>
        </div>

        <!-- PROJECTS TAB -->
        <div class="tab projects" data-group="primary" data-tab="projects">
            <div class="flexrow" style="align-items:center; justify-content:space-between; background:#ddd; padding:2px;">
                <h3>Производство (Крафт)</h3>
                <a class="item-create" data-type="project" title="Проект"><i class="fas fa-hammer"></i> Добавить</a>
            </div>
            <ol class="item-list">
                {{#each activeProjects as |item|}}
                    {{> "systems/zsystem/sheets/partials/project-card.hbs" item=item type="project"}}
                {{/each}}
            </ol>
        </div>

        <!-- FACILITIES TAB (Split Columns) -->
        <div class="tab facilities" data-group="primary" data-tab="facilities">
            <div class="shelter-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                
                <!-- COLUMN 1: COMPLETED UPGRADES (Постройки) -->
                <div class="panel">
                    <h3 style="border-bottom:1px solid #ccc; margin-bottom:5px;">Постройки (Функционируют)</h3>
                    <ol class="item-list">
                        {{#each completedUpgrades as |item|}}
                        <li class="item" data-item-id="{{item._id}}" style="padding:5px; border-bottom:1px solid #ccc; background:rgba(0,128,0,0.05); margin-bottom: 5px; border: 1px solid #a5d6a7;">
                            
                            <!-- Header -->
                            <div class="flexrow" style="align-items:center;">
                                <img src="{{item.img}}" width="36" height="36" style="margin-right:10px; border:1px solid #333;"/>
                                <div style="flex:1;">
                                    <h4 style="margin:0;">{{item.name}}</h4>
                                    <div style="font-size:0.8em; color:darkgreen;">
                                        Бонус: {{item.system.bonusType}} +{{item.system.bonusValue}}
                                    </div>
                                </div>
                                <div class="item-controls">
                                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                                    <a class="item-delete"><i class="fas fa-trash"></i></a>
                                </div>
                            </div>

                            <!-- Workers Section (COPIED FROM PROJECT CARD) -->
                            <div style="margin-top:5px; border-top:1px dashed #999; padding-top:2px;">
                                <div class="flexrow" style="justify-content: space-between; align-items: center; font-size: 0.85em;">
                                    <strong>Персонал ({{item.workersList.length}}/{{item.system.minPeople}}):</strong>
                                    <a class="add-worker-btn" title="Назначить сотрудника" style="color:green; cursor:pointer;"><i class="fas fa-user-plus"></i></a>
                                </div>
                                
                                <div style="display:flex; flex-wrap:wrap; gap:2px; margin-top:2px;">
                                    {{#each item.workersList as |worker|}}
                                    <span style="background:#fff; border:1px solid #aaa; padding:1px 4px; font-size:0.8em; border-radius:3px; display:flex; align-items:center;">
                                        <a class="open-resident" data-id="{{worker.id}}" style="color:black; margin-right:4px; font-weight:bold;">{{worker.name}}</a>
                                        <a class="remove-worker" data-id="{{worker.id}}" style="color:red; cursor:pointer;" title="Снять с должности">×</a>
                                    </span>
                                    {{/each}}
                                    {{#unless item.workersList.length}}
                                    <span style="color:#d32f2f; font-style:italic; font-size:0.8em;">
                                        <i class="fas fa-exclamation-triangle"></i> Нет персонала! Не работает.
                                    </span>
                                    {{/unless}}
                                </div>
                            </div>

                        </li>
                        {{/each}}
                        {{#unless completedUpgrades}}
                            <li style="text-align:center; color:gray; font-style:italic; padding:10px;">Нет завершенных построек</li>
                        {{/unless}}
                    </ol>
                </div>

                <!-- COLUMN 2: COMPLETED PROJECTS (Архив) -->
                <!-- Проекты (крафт) обычно одноразовые или не требуют постоянного персонала ПОСЛЕ завершения, 
                     но если нужно повторяемое производство, логика та же. Пока оставим архивом. -->
                <div class="panel">
                    <h3 style="border-bottom:1px solid #ccc; margin-bottom:5px;">Архив Проектов</h3>
                    <ol class="item-list">
                        {{#each completedProjects as |item|}}
                        <li class="item flexrow" data-item-id="{{item._id}}" style="padding:5px; border-bottom:1px solid #ccc; background:rgba(0,0,255,0.05); align-items:center;">
                            <img src="{{item.img}}" width="30" height="30" style="margin-right:10px;"/>
                            <div style="flex:1;">
                                <h4 style="margin:0;">{{item.name}}</h4>
                                <div style="font-size:0.8em; color:darkblue;">
                                    {{item.system.bonusType}} +{{item.system.bonusValue}}
                                </div>
                            </div>
                            <div class="item-controls">
                                <a class="item-edit"><i class="fas fa-edit"></i></a>
                                <a class="item-delete"><i class="fas fa-trash"></i></a>
                            </div>
                        </li>
                        {{/each}}
                    </ol>
                </div>
            </div>
        </div>

        <!-- RESIDENTS TAB -->
        <div class="tab residents" data-group="primary" data-tab="residents">
            <div style="text-align:center; margin-bottom:10px; font-style:italic; color:#666;">
                Перетащите Акторов сюда, чтобы добавить их в убежище.
            </div>
            <ol class="item-list">
                {{#each residentActors as |actor|}}
                <li class="item flexrow resident-card" draggable="true" data-document-id="{{actor.id}}" style="padding:5px; border-bottom:1px solid #ccc; align-items:center;">
                    <img src="{{actor.img}}" width="30" height="30" style="margin-right:10px; border:1px solid #333;"/>
                    
                    <!-- ИЗМЕНЕНИЕ: ССЫЛКА НА ОТКРЫТИЕ -->
                    <a class="open-resident" data-id="{{actor.id}}" style="flex:1; font-weight:bold; color:#0d47a1; cursor:pointer;">
                        {{actor.name}}
                    </a>
                    
                    <div style="margin-right:10px; font-size:0.9em;">
                        <i class="fas fa-heart" style="color:#b71c1c;"></i> {{actor.system.resources.hp.value}}
                    </div>
                    <a class="remove-resident" data-id="{{actor.id}}" title="Выгнать" style="color:#d32f2f;"><i class="fas fa-sign-out-alt"></i></a>
                </li>
                {{/each}}
            </ol>
        </div>

        <!-- INVENTORY TAB -->
        <div class="tab inventory" data-group="primary" data-tab="inventory">
            <div class="inventory-controls flexrow" style="margin-bottom:10px;">
                <a class="item-create" data-type="select"><i class="fas fa-plus"></i> Добавить предмет</a>
            </div>
            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.05); border: 2px dashed #5d4037; text-align: center;">
    <p style="font-size: 0.9em; margin-bottom: 8px;">Перетащите еду и материалы сюда, затем нажмите кнопку ниже:</p>
    <button type="button" class="process-stockpile-btn" style="background: #2e7d32; color: white; font-weight: bold; height: 40px; cursor: pointer;">
        <i class="fas fa-boxes"></i> Утилизировать и пополнить ресурсы
    </button>
</div>
            <ol class="items-list">
                {{#each inventory as |section key|}}
                <li class="item-header flexrow" style="background:#ddd; padding:5px; font-weight:bold;">
                    <h3>{{section.label}}</h3>
                    <div style="text-align:center; width:50px;">Кол.</div>
                    <div style="width:50px;"></div>
                </li>
                <ol class="item-list">
                {{#each section.items as |item|}}
                    <li class="item flexrow" draggable="true" data-item-id="{{item._id}}" style="padding:5px; border-bottom:1px solid #eee; align-items:center;">
                        <img src="{{item.img}}" width="24" height="24" style="margin-right:5px;"/>
                        <h4 style="margin:0;">{{item.name}}</h4>
                        <div style="text-align:center; width:50px;">{{item.system.quantity}}</div>
                        <div class="item-controls" style="width:50px; text-align:right;">
                            <a class="item-edit"><i class="fas fa-edit"></i></a>
                            <a class="item-delete"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                {{/each}}
                </ol>
                {{/each}}
            </ol>
        </div>
    </section>
</form>