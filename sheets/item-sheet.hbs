<form class="{{cssClass}}" autocomplete="off">
  <header class="sheet-header" style="display:flex; align-items:center; gap:10px;">
    <img src="{{item.img}}" data-edit="img" title="{{item.name}}" style="flex:0 0 64px; height:64px; border:1px solid #333;"/>
    <div class="header-fields" style="flex:1;">
        <h1><input name="name" type="text" value="{{item.name}}" placeholder="Название"/></h1>
        <div class="grid grid-2col">
            <div class="form-group">
                <label>Вес</label>
                <input type="number" name="system.weight" value="{{system.weight}}" step="0.1"/>
            </div>
            <div class="form-group">
                <label>Кол-во</label>
                <input type="number" name="system.quantity" value="{{system.quantity}}"/>
            </div>
        </div>
    </div>
  </header>

  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="details">Параметры</a>
    <a class="item" data-tab="description">Описание</a>
  </nav>

  <section class="sheet-body">
    
    <!-- TAB: DETAILS -->
    <div class="tab details" data-group="primary" data-tab="details">

        <!-- СЕКЦИЯ ПРОЕКТОВ И ПОСТРОЕК -->
        {{#if (or (eq item.type "upgrade") (eq item.type "project"))}}
        <div class="project-settings">
            <h3>Требования Проекта</h3>
            <div class="grid grid-2col">
                <div class="form-group">
                    <label>Время (Часы)</label>
                    <input type="number" name="system.hoursNeeded" value="{{system.hoursNeeded}}"/>
                </div>
                <div class="form-group">
                    <label>Стоимость (Детали)</label>
                    <input type="number" name="system.partsCost" value="{{system.partsCost}}"/>
                </div>
                <div class="form-group">
                    <label>Мин. Людей</label>
                    <input type="number" name="system.minPeople" value="{{system.minPeople}}"/>
                </div>
                <div class="form-group">
                    <label>Навык</label>
                    <select name="system.reqSkill">
                        {{selectOptions skillsList selected=system.reqSkill localize=false}}
                    </select>
                </div>
                <div class="form-group">
                    <label>Мин. Уровень Навыка</label>
                    <input type="number" name="system.reqLevel" value="{{system.reqLevel}}"/>
                </div>
            </div>
            <div class="form-group">
                <label>Текущий прогресс (Часы)</label>
                <input type="number" name="system.progress" value="{{system.progress}}"/>
            </div>
            <div class="form-group">
                <label>Внесено деталей</label>
                <input type="number" name="system.partsPaid" value="{{system.partsPaid}}"/>
            </div>
            <hr>
            <h3>Эффект при завершении (Ежедневный)</h3>
            <div class="grid grid-2col">
                <div class="form-group">
                    <label>Тип Бонуса</label>
                    <select name="system.bonusType">
                        {{selectOptions bonusTypes selected=system.bonusType localize=false}}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Значение / Кол-во</label>
                    <input type="number" name="system.bonusValue" value="{{system.bonusValue}}"/>
                </div>

                {{#if (eq system.bonusType "medicine")}}
                <div class="form-group" style="grid-column: span 2;">
                    <label>Создаваемый предмет (название)</label>
                    <input type="text" name="system.outputItem" value="{{system.outputItem}}" placeholder="Например: Бинт"/>
                </div>
                {{/if}}

                <div class="form-group flexrow">
                    <label>Завершено?</label>
                    <input type="checkbox" name="system.isCompleted" {{checked system.isCompleted}}/>
                </div>
            </div>
        </div>
        {{/if}}
        
        <!-- === СЕКЦИЯ ОРУЖИЯ === -->
        {{#if (eq item.type "weapon")}}
        <div class="weapon-properties">
            <div class="grid grid-3col">
                <!-- Тип и Хват -->
                <div class="form-group">
                    <label>Тип</label>
                    <select name="system.weaponType">
                        {{selectOptions weaponTypes selected=system.weaponType localize=false}}
                    </select>
                </div>
                <div class="form-group">
                    <label>Хват</label>
                    <select name="system.hands">
                        {{selectOptions handsOptions selected=system.hands localize=false}}
                    </select>
                </div>
                <div class="form-group">
                    <label>Урон</label>
                    <select name="system.damageType">
                        {{selectOptions damageTypes selected=system.damageType localize=false}}
                    </select>
                </div>
                
                <!-- Параметры -->
                <div class="form-group">
                    <label>Дальность</label>
                    <input type="number" name="system.range" value="{{system.range}}"/>
                </div>
                <div class="form-group">
                    <label>Шум</label>
                    <input type="number" name="system.noise" value="{{system.noise}}"/>
                </div>
                <div class="form-group">
                    <label>Треб. Силы</label>
                    <input type="number" name="system.strReq" value="{{system.strReq}}"/>
                </div>
                
                <!-- ПАТРОНЫ И МАГАЗИН -->
                <div class="form-group">
                    <label>Патроны (тип)</label>
                    <input type="text" name="system.ammoType" value="{{system.ammoType}}" placeholder="Напр: 9mm"/>
                </div>

                <div class="form-group"><label>Емкость Маг.</label><input type="number" name="system.mag.max" value="{{system.mag.max}}"/></div>
                <div class="form-group"><label>В стволе</label><input type="number" name="system.mag.value" value="{{system.mag.value}}"/></div>
                <div class="form-group"><label>AP Перезаряд.</label><input type="number" name="system.reloadAP" value="{{system.reloadAP}}"/></div>

                <div class="form-group">
                    <label>Шанс Крита (+%)</label>
                    <input type="number" name="system.critChance" value="{{system.critChance}}" placeholder="0"/>
                </div>
                <div class="form-group">
                    <label>Крит Множитель (x)</label>
                    <input type="number" name="system.critMult" value="{{system.critMult}}" step="0.1" placeholder="1.5"/>
                </div>

                <!-- Прочность -->
                <div class="form-group">
                    <label>Прочность</label>
                    <div class="flexrow">
                        <input type="number" name="system.hp.value" value="{{system.hp.value}}" placeholder="Cur"/>
                        <span>/</span>
                        <input type="number" name="system.hp.max" value="{{system.hp.max}}" placeholder="Max"/>
                    </div>
                </div>
            </div>

            <hr>
            
            <!-- Метательное оружие -->
            <div class="form-group flexrow">
                <label>Метательное?</label>
                <input type="checkbox" name="system.isThrowing" {{checked system.isThrowing}}/>
            </div>
            
            {{#if system.isThrowing}}
            <div class="grid grid-2col" style="background: rgba(255,100,0,0.1); padding: 5px; border-radius: 4px; margin-bottom: 10px;">
                <div class="form-group">
                    <label>Радиус Взрыва (м)</label>
                    <input type="number" name="system.blastRadius" value="{{system.blastRadius}}"/>
                </div>
                <div class="form-group">
                    <label>Форма</label>
                    <select name="system.templateType">
                        <option value="circle" {{#if (eq system.templateType "circle")}}selected{{/if}}>Круг</option>
                        <option value="cone" {{#if (eq system.templateType "cone")}}selected{{/if}}>Конус</option>
                    </select>
                </div>
            </div>
            {{/if}}

            <!-- Секция Атак -->
             <div class="attacks-section">
                <div class="flexrow" style="align-items:center; margin-bottom:5px; gap: 5px;">
                    <h3>Варианты Атаки</h3>
                    
                    {{#if isHybrid}}
                    <a class="generate-hybrid" title="Создать Удар/Бросок" style="font-size:0.8em; background:#333; color:#fff; padding:2px 5px; border-radius:3px;">
                        <i class="fas fa-magic"></i> Авто
                    </a>
                    {{/if}}

                    <a class="attack-create" title="Добавить атаку" style="margin-left:auto;"><i class="fas fa-plus"></i></a>
                </div>
                
                <div class="attacks-table">
                    <!-- HEADER -->
                    <div class="attack-header flexrow" style="border-bottom:1px solid #777; padding-bottom:2px; margin-bottom:5px; font-weight:bold; font-size: 0.9em;">
                        <div style="flex:1.5">Название</div>
                        <div style="flex:0.4; text-align:center;">AP</div>
                        <div style="flex:0.4; text-align:center;">Шум</div>
                        <div style="flex:0.8; text-align:center;">Урон</div>
                        <div style="flex:0.4; text-align:center;">Точн.</div>
                        <div style="flex:1; text-align:center;">Эффект</div>
                        <div style="flex:0.4; text-align:center;">%</div>
                        <div style="flex:0.3"></div>
                    </div>
                    
                    {{#each system.attacks as |attack key|}}
                    <div class="attack-row flexrow" style="margin-top: 5px; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px; align-items:center;">
                        
                        <!-- ВАЖНО: СКРЫТОЕ ПОЛЕ MODE -->
                        <input type="hidden" name="system.attacks.{{key}}.mode" value="{{attack.mode}}"/>

                        <div style="flex:1.5"><input type="text" name="system.attacks.{{key}}.name" value="{{attack.name}}" placeholder="Name"/></div>
                        <div style="flex:0.4"><input type="number" name="system.attacks.{{key}}.ap" value="{{attack.ap}}"/></div>
                        
                        <div style="flex:0.4"><input type="number" name="system.attacks.{{key}}.noise" value="{{attack.noise}}" placeholder="0"/></div>
                        
                        <div style="flex:0.8"><input type="text" name="system.attacks.{{key}}.dmg" value="{{attack.dmg}}"/></div>
                        <div style="flex:0.4"><input type="number" name="system.attacks.{{key}}.mod" value="{{attack.mod}}"/></div>
                        
                        <div style="flex:1">
                            <select name="system.attacks.{{key}}.effect" style="width:100%; font-size:0.8em;">
                                {{selectOptions ../statusOptions selected=attack.effect localize=false}}
                            </select>
                        </div>
                        <div style="flex:0.4"><input type="number" name="system.attacks.{{key}}.chance" value="{{attack.chance}}" placeholder="%"/></div>

                        <div style="flex:0.3; text-align:center;"><a class="attack-delete" data-key="{{key}}"><i class="fas fa-trash"></i></a></div>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        {{/if}}

        <!-- ПАТРОНЫ -->
        {{#if (eq item.type "ammo")}}
        <div class="ammo-properties">
            <div class="form-group">
                <label>Калибр</label>
                <input type="text" name="system.calibre" value="{{system.calibre}}" placeholder="Напр: 9mm"/>
            </div>
        </div>
        {{/if}}
        
        <!-- ЕДА (НОВАЯ СЕКЦИЯ) -->
        {{#if (eq item.type "food")}}
        <div class="food-properties" style="background: rgba(0,255,0,0.05); padding: 5px; border-radius: 4px; border: 1px solid #777;">
            <h3>Склад Убежища</h3>
            <div class="form-group">
                <label>Очков Провизии (Resource Value)</label>
                <input type="number" name="system.resourceValue" value="{{system.resourceValue}}" placeholder="Напр: 1"/>
                <p class="notes" style="font-size: 0.8em; color: #888; margin-top: 2px;">
                    Вклад в общий запас еды при сдаче на склад. (Потребление: 3/чел в день)
                </p>
            </div>
        </div>
        {{/if}}

        <!-- МЕДИЦИНА -->
        {{#if (eq item.type "medicine")}}
        <div class="medicine-properties">
             <div class="grid grid-2col">
                <div class="form-group">
                    <label>Сила Лечения</label>
                    <input type="number" name="system.healAmount" value="{{system.healAmount}}"/>
                </div>
                <div class="form-group flexrow">
                    <label>Это Антибиотик?</label>
                    <input type="checkbox" name="system.isAntibiotic" {{checked system.isAntibiotic}}/>
                </div>
             </div>
        </div>
        {{/if}}

        <!-- БРОНЯ -->
        {{#if (eq item.type "armor")}}
        <div class="armor-properties">
            <div class="form-group">
                <label>AC (Класс Брони)</label>
                <input type="number" name="system.ac" value="{{system.ac}}"/>
            </div>
            <!-- ... DR Table ... -->
            <div class="coverage-table" style="margin-top:10px; border-top:1px dashed #777; padding-top:5px;">
                <label style="font-weight:bold;">Зоны покрытия:</label>
                <div class="grid grid-3col">
                    <label><input type="checkbox" name="system.coverage.head" {{checked system.coverage.head}}/> Голова</label>
                    <label><input type="checkbox" name="system.coverage.torso" {{checked system.coverage.torso}}/> Торс</label>
                    <label><input type="checkbox" name="system.coverage.lArm" {{checked system.coverage.lArm}}/> Л.Рука</label>
                    <label><input type="checkbox" name="system.coverage.rArm" {{checked system.coverage.rArm}}/> П.Рука</label>
                    <label><input type="checkbox" name="system.coverage.lLeg" {{checked system.coverage.lLeg}}/> Л.Нога</label>
                    <label><input type="checkbox" name="system.coverage.rLeg" {{checked system.coverage.rLeg}}/> П.Нога</label>
                </div>
            </div>
        </div>
        {{/if}}

        {{#if (ne item.type "weapon")}}
        {{#if (ne item.type "armor")}}
            <div class="form-group" style="margin-top: 10px;">
                <label>Категория</label>
                <select name="system.category">
                    {{selectOptions categoryOptions selected=system.category localize=false}}
                </select>
            </div>
        {{/if}}
        {{/if}}

    </div>

    <!-- TAB: DESCRIPTION -->
    <div class="tab description" data-group="primary" data-tab="description">
        <textarea name="system.description">{{system.description}}</textarea>
    </div>
  </section>
</form>