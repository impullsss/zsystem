<form class="{{cssClass}}" autocomplete="off">
    <header class="sheet-header">
        <img class="profile-img-box" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
        <div style="flex:1;">
            <input class="charname-input" name="name" type="text" value="{{actor.name}}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" {{#unless isGM}}disabled style="cursor:default; border:none;"{{/unless}}/>
        </div>
    </header>

    <!-- GM CONFIG -->
    {{#if isGM}}
    <nav class="gm-tabs tabs" data-group="primary">
        <a class="item gm-tab" data-tab="actions">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</a>
        <a class="item gm-tab" data-tab="outcomes">üìù –ò—Ç–æ–≥–∏</a>
        <a class="item gm-tab" data-tab="loot">üì¶ –õ—É—Ç</a>
        <a class="reset-btn" style="margin-left:auto;color:#d84315; font-size:0.9em; align-self:center; cursor:pointer;"><i class="fas fa-undo"></i> –°–±—Ä–æ—Å</a>
    </nav>
    {{/if}}

    <div class="sheet-body">
        
        {{#if isGM}}
        <!-- TAB 1: ACTIONS -->
        <div class="tab" data-tab="actions">
            <div style="text-align:right; margin-bottom:5px;">
                <a class="add-action" style="color:#2e7d32; font-weight:bold; cursor:pointer;"><i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</a>
            </div>
            
            {{#each actions as |act idx|}}
            <div class="action-config" data-idx="{{idx}}">
                <div class="action-header">
                    <input type="text" class="action-input" data-field="name" value="{{act.name}}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è" style="font-weight:bold; width:70%;"/>
                    <a class="delete-action" data-idx="{{idx}}" style="color:red; cursor:pointer;"><i class="fas fa-trash"></i></a>
                </div>
                
                <div class="grid grid-2col" style="gap:5px;">
                    <select class="action-input" data-field="skill">
                        {{selectOptions ../skillsList selected=act.skill localize=false}}
                    </select>
                    <input type="number" class="action-input" data-field="dc" value="{{act.dc}}" placeholder="DC (–°–ª–æ–∂–Ω–æ—Å—Ç—å)"/>
                </div>
                
                <!-- TOOLS CONFIG -->
                <div style="margin-top: 8px; border-top: 1px dotted #8d6e63; padding-top: 5px;">
                    
                    <!-- 1. –í–µ—Ä—Ö–Ω–∏–π –∏–Ω–ø—É—Ç: –ü—Ä–µ–¥–º–µ—Ç (Drag Zone) -->
                    <div style="margin-bottom: 5px;">
                        <label style="font-size: 0.8em; font-weight: bold; color: #5d4037;">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:</label>
                        <input type="text" class="action-input tool-drop" data-field="reqTool" value="{{act.reqTool}}" 
                               placeholder="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç —Å—é–¥–∞..." 
                               style="width: 100%; height: 35px; background: rgba(255,255,255,0.9); border: 2px dashed #795548; text-align: center;"/>
                        
                        <div style="text-align: right;">
                            <label style="font-size: 0.8em;">
                                <input type="checkbox" class="action-input" data-field="toolRequired" {{checked act.toolRequired}}/> –û–±—è–∑–∞—Ç–µ–ª–µ–Ω?
                            </label>
                        </div>
                    </div>

                    <!-- 2. –ù–∏–∂–Ω–∏–π –∏–Ω–ø—É—Ç: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä -->
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label style="font-size: 0.8em; font-weight: bold; color: #5d4037;">–ë–æ–Ω—É—Å –∫ —à–∞–Ω—Å—É (%):</label>
                        <input type="number" class="action-input" data-field="bonusMod" value="{{act.bonusMod}}" placeholder="0" 
                               style="width: 60px; text-align: center; border-bottom: 2px solid #5d4037; background: transparent; font-weight: bold;"/>
                    </div>
                </div>
            {{/each}}
            
            <div style="margin-top:10px;">
                <label>–°–∫—Ä—ã—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea class="harvest-desc-input" rows="2">{{description}}</textarea>
            </div>
        </div>

        <!-- TAB 2: OUTCOMES -->
        <div class="tab" data-tab="outcomes">
            <div class="outcome-box">
                <label class="outcome-label success">–£—Å–ø–µ—Ö (–¢–µ–∫—Å—Ç)</label>
                <input type="text" class="outcome-input" data-field="outcomes.success.text" value="{{outcomes.success.text}}"/>
            </div>
            <div class="outcome-box">
                <label class="outcome-label fail">–ü—Ä–æ–≤–∞–ª (–¢–µ–∫—Å—Ç / –®—É–º)</label>
                <div class="flexrow">
                    <input type="text" class="outcome-input" data-field="outcomes.fail.text" value="{{outcomes.fail.text}}"/>
                    <input type="number" class="outcome-input" data-field="outcomes.fail.noise" value="{{outcomes.fail.noise}}" placeholder="Noise" style="width:50px;"/>
                </div>
            </div>
            <div class="outcome-box">
                <label class="outcome-label crit-fail">–ö—Ä–∏—Ç. –ü—Ä–æ–≤–∞–ª (–¢–µ–∫—Å—Ç / –®—É–º)</label>
                <div class="flexrow">
                    <input type="text" class="outcome-input" data-field="outcomes.critFail.text" value="{{outcomes.critFail.text}}"/>
                    <input type="number" class="outcome-input" data-field="outcomes.critFail.noise" value="{{outcomes.critFail.noise}}" placeholder="Noise" style="width:50px;"/>
                </div>
            </div>
        </div>

        <!-- TAB 3: LOOT PREVIEW -->
        <div class="tab" data-tab="loot">
            <div class="section-header">GM Preview <a class="item-create" style="cursor:pointer;"><i class="fas fa-plus"></i></a></div>
            <ol class="light-item-list">
                {{#each inventory as |item|}}
                    <li class="light-item" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" width="20" height="20"/>
                        <span class="item-name">{{item.name}}</span>
                        <span class="item-qty">x{{item.system.quantity}}</span>
                        <div class="item-controls">
                            <a class="item-edit"><i class="fas fa-edit"></i></a>
                            <a class="item-delete"><i class="fas fa-trash"></i></a>
                        </div>
                    </li>
                {{/each}}
            </ol>
        </div>
        {{/if}}

        <!-- PLAYER VIEW -->
        {{#unless isGM}}
            <!-- –û–ü–ò–°–ê–ù–ò–ï -->
            {{#if description}}
                <div class="harvest-description-box">"{{description}}"</div>
            {{/if}}

            {{#if isBroken}}
                <div class="harvest-lock-screen" style="border-color:#ef5350; background:#ffebee;">
                    <i class="fas fa-times-circle" style="font-size:48px; color:#c62828;"></i>
                    <h2 style="color:#c62828;">–°–õ–û–ú–ê–ù–û</h2>
                </div>
            {{else}}
                {{#if isHarvested}}
                    <!-- LOOT VIEW -->
                    <div class="section-header"><span><i class="fas fa-box-open"></i> –°–æ–¥–µ—Ä–∂–∏–º–æ–µ</span></div>
                    <ol class="light-item-list">
                        {{#each inventory as |item|}}
                        <li class="light-item" data-item-id="{{item.id}}">
                            <img src="{{item.img}}" width="24" height="24"/>
                            <span class="item-name">{{item.name}}</span>
                            <span class="item-qty">x{{item.system.quantity}}</span>
                            <div class="item-controls">
                                <a class="item-take" title="–í–∑—è—Ç—å" style="cursor:pointer; color:#2e7d32;"><i class="fas fa-hand-paper"></i></a>
                            </div>
                        </li>
                        {{/each}}
                        {{#unless inventory}}<li style="text-align:center;color:#777;padding:10px;">–ü—É—Å—Ç–æ...</li>{{/unless}}
                    </ol>
                {{else}}
                    <!-- ACTIONS VIEW -->
                    <div class="harvest-lock-screen">
                        <i class="fas fa-lock" style="font-size:48px; color:#555; margin-bottom:15px;"></i>
                        
                        {{#if canHarvest}}
                            {{#each actions as |act idx|}}
                                <button class="harvest-action-btn" data-idx="{{idx}}">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <span><i class="fas fa-tools"></i> {{act.name}}</span>
                                        <span style="font-size:0.8em; font-weight:normal;">({{act.skill}})</span>
                                    </div>
                                    {{#if act.reqTool}}
                                        <div style="font-size:0.7em; color:#ffebee; margin-top:2px;">
                                            <i class="fas fa-key"></i> –¢—Ä–µ–±—É–µ—Ç—Å—è: {{act.reqTool}}
                                        </div>
                                    {{/if}}
                                </button>
                            {{/each}}
                        {{else}}
                            <div class="status-msg error">{{distanceMsg}}</div>
                        {{/if}}
                    </div>
                {{/if}}
            {{/if}}
        {{/unless}}
    </div>
</form>