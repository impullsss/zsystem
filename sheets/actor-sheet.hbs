<form class="{{cssClass}}" autocomplete="off">
  
  {{#if isDead}}<div class="dead-stamp">МЕРТВ</div>{{/if}}

  <!-- 1. HEADER -->
  <div class="clipboard-header">
      <div class="profile-img-container">
          <img src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
      </div>

      <div class="header-stats">
          <div style="border-bottom: 1px solid #333;">
              <input name="name" type="text" value="{{actor.name}}" placeholder="Имя Выжившего" style="font-size: 1.5em; border:none; width:100%;"/>
          </div>

          <!-- HP Bar -->
          <div class="stat-bar">
              <span class="bar-label">HP</span>
              <div class="bar-track">
                  <div class="bar-fill hp" style="width: {{calculatePercentage system.resources.hp.value system.resources.hp.max}}%;"></div>
                  <div class="bar-inputs">
                      <!-- Ограничение max -->
                      <input type="number" name="system.resources.hp.value" value="{{system.resources.hp.value}}" 
                             min="0" max="{{system.resources.hp.max}}" title="Текущее"/>
                      <span style="color:#fff; font-weight:bold;">/</span>
                      <input type="number" value="{{system.resources.hp.max}}" disabled title="Максимум"/>
                  </div>
              </div>
          </div>

          <!-- AP Bar -->
          <div class="stat-bar" style="margin-bottom: 2px;"> <!-- margin для бонуса -->
              <span class="bar-label">AP</span>
              <div class="bar-track">
                  <div class="bar-fill ap" style="width: {{calculatePercentage system.resources.ap.value system.resources.ap.max}}%;"></div>
                  <div class="bar-inputs">
                      <!-- Ограничение max -->
                      <input type="number" name="system.resources.ap.value" value="{{system.resources.ap.value}}" 
                             min="0" max="{{system.resources.ap.max}}" title="Текущее"/>
                      <span style="color:#fff; font-weight:bold;">/</span>
                      <input type="number" value="{{system.resources.ap.max}}" disabled title="Максимум"/>
                  </div>
              </div>
              <a class="ap-reset" title="Сброс AP" style="margin-left:5px; color:#333;"><i class="fas fa-sync"></i></a>
          </div>

          <!-- AP BONUS FIELD (ВОЗВРАЩЕНО) -->
          <div style="display:flex; justify-content: flex-end; align-items: center; font-size: 0.8em; color:#555; margin-right: 25px;">
              <span>Бонус AP:</span>
              <input type="number" name="system.resources.ap.bonus" value="{{system.resources.ap.bonus}}" 
                     style="width: 30px; margin-left: 5px; text-align: center; border-bottom: 1px dotted #555; color: #000; font-weight: bold;"/>
          </div>

          <!-- Controls -->
          <div class="flexrow" style="gap:5px; margin-top:5px;">
              <button type="button" class="rest-btn" style="font-size:0.8em; padding:2px;"><i class="fas fa-bed"></i> Отдых</button>
              {{#if isProne}}<button type="button" class="stand-up-btn" style="font-size:0.8em; padding:2px; background:#ffcc80;"><i class="fas fa-child"></i> Встать</button>{{/if}}
          </div>

          {{#if isGM}}
          <div class="gm-infection-box">
              <i class="fas fa-biohazard"></i> Инфекция:
              <input type="number" name="system.resources.infection.stage" value="{{system.resources.infection.stage}}" min="0" max="3" style="width:30px; border-bottom:1px solid red;"/>
              {{#if (gte system.resources.infection.stage 3)}}<a class="zombie-rise-btn" style="color:red; font-weight:bold;">ВОССТАТЬ!</a>{{/if}}
              <a class="full-heal-btn" title="Full Heal" style="margin-left:auto; color:green;"><i class="fas fa-heart"></i></a>
          </div>
          {{/if}}
      </div>
  </div>

  <!-- 2. TABS (Translated) -->
  <nav class="sheet-tabs tabs" data-group="primary">
    {{#unless (and isDead (not isGM))}}
    <a class="item" data-tab="main">Статус</a>
    {{/unless}}
    <a class="item" data-tab="inventory">Рюкзак</a>
    {{#unless (and isDead (not isGM))}}
    <a class="item" data-tab="effects">Эффекты</a>
    {{/unless}}
  </nav>

  <!-- 3. BODY -->
  <section class="sheet-body">
    
    <!-- TAB: MAIN -->
    <div class="tab main" data-group="primary" data-tab="main">
        {{#unless (and isDead (not isGM))}}
        <div class="paper-grid">
            
            <!-- COL 1: ATTRIBUTES & SKILLS -->
            <div class="col-left">
                <!-- ATTRIBUTES -->
                <div>
                    <h3 style="display:flex; justify-content:space-between;">
                        ХАР-КИ
                        <span style="font-size:0.5em; color:#666; font-weight:normal; margin-top:5px;">(Потрачено: {{system.secondary.spentStats.value}})</span>
                    </h3>
                    
                    <div class="attr-grid attr-header">
                        <span>Название</span>
                        <span>База</span>
                        <span>Мод</span>
                        <span>Итог</span>
                    </div>

                    {{#each system.attributes as |attr key|}}
                    <div class="attr-grid attr-row">
                        <label>{{lookup ../labels.attributes key}}</label>
                        <input type="number" name="system.attributes.{{key}}.base" value="{{attr.base}}"/>
                        <span class="attr-mod" style="{{#if (ne attr.mod 0)}}color:#d84315; font-weight:bold;{{/if}}">
                            {{numberFormat attr.mod sign=true}}
                        </span>
                        <span class="attr-total">{{attr.value}}</span>
                    </div>
                    {{/each}}
                </div>

                <!-- SKILLS -->
                <div style="margin-top:15px;">
                    <h3 style="display:flex; justify-content:space-between;">
                        НАВЫКИ
                        <span style="font-size:0.5em; color:#666; font-weight:normal; margin-top:5px;">(XP: {{system.secondary.spentSkills.value}})</span>
                    </h3>
                    
                    <div class="skill-grid skill-header">
                        <span>Название</span>
                        <span>База</span>
                        <span></span>
                        <span>Очки</span>
                        <span></span>
                        <span>Итог</span>
                        <span></span>
                    </div>

                    <ul class="skills-list" style="border:none; padding:0;">
                        {{#each system.skills as |skill key|}}
                        <li class="skill-grid skill-row" data-skill="{{key}}">
                            <span class="skill-name">{{lookup ../labels.skills key}}</span>
                            
                            <span class="skill-base-text" style="color:#777; font-size:0.8em; text-align:center;">{{skill.base}}</span>
                            <span style="color:#aaa; text-align:center;">+</span>
                            <input class="skill-input" type="number" name="system.skills.{{key}}.points" value="{{skill.points}}"/>
                            <span style="color:#aaa; text-align:center;">=</span>
                            <span class="skill-val">{{skill.value}}</span>
                            
                            <a class="skill-roll"><i class="fas fa-dice"></i></a>
                        </li>
                        {{/each}}
                    </ul>
                </div>
            </div>

            <!-- COL 2: DOLL & SECONDARY -->
            <div class="col-center">
                <h3 style="text-align:center;">СТАТУС</h3>
                
                <div class="body-chart-container">
                    <svg class="body-chart" viewBox="0 0 200 300">
                        <!-- ГОЛОВА -->
                        <g data-limb="head" class="limb-zone">
                            <title>Голова: {{system.limbs.head.value}} / {{system.limbs.head.max}}</title>
                            <circle cx="100" cy="40" r="25" class="limb-shape" 
                                    style="fill: {{getLimbColor system.limbs.head.value system.limbs.head.max}}"/>
                        </g>
                        
                        <!-- ТОРС -->
                        <g data-limb="torso" class="limb-zone">
                            <title>Торс: {{system.limbs.torso.value}} / {{system.limbs.torso.max}}</title>
                            <rect x="70" y="70" width="60" height="100" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.torso.value system.limbs.torso.max}}"/>
                        </g>
                        
                        <!-- ЛЕВАЯ РУКА -->
                        <g data-limb="lArm" class="limb-zone">
                            <title>Л.Рука: {{system.limbs.lArm.value}} / {{system.limbs.lArm.max}}</title>
                            <rect x="35" y="70" width="30" height="90" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.lArm.value system.limbs.lArm.max}}"/>
                        </g>
                        
                        <!-- ПРАВАЯ РУКА -->
                        <g data-limb="rArm" class="limb-zone">
                            <title>П.Рука: {{system.limbs.rArm.value}} / {{system.limbs.rArm.max}}</title>
                            <rect x="135" y="70" width="30" height="90" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.rArm.value system.limbs.rArm.max}}"/>
                        </g>
                        
                        <!-- ЛЕВАЯ НОГА -->
                        <g data-limb="lLeg" class="limb-zone">
                            <title>Л.Нога: {{system.limbs.lLeg.value}} / {{system.limbs.lLeg.max}}</title>
                            <rect x="70" y="175" width="28" height="110" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.lLeg.value system.limbs.lLeg.max}}"/>
                        </g>
                        
                        <!-- ПРАВАЯ НОГА -->
                        <g data-limb="rLeg" class="limb-zone">
                            <title>П.Нога: {{system.limbs.rLeg.value}} / {{system.limbs.rLeg.max}}</title>
                            <rect x="102" y="175" width="28" height="110" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.rLeg.value system.limbs.rLeg.max}}"/>
                        </g>
                    </svg>
                    <!-- Inputs -->
                    <div class="limb-input" style="top:30px; left:85px;"><input type="number" name="system.limbs.head.value" value="{{system.limbs.head.value}}"></div>
                    <div class="limb-input" style="top:110px; left:85px;"><input type="number" name="system.limbs.torso.value" value="{{system.limbs.torso.value}}"></div>
                    <div class="limb-input" style="top:110px; left:40px;"><input type="number" name="system.limbs.lArm.value" value="{{system.limbs.lArm.value}}"></div>
                    <div class="limb-input" style="top:110px; left:140px;"><input type="number" name="system.limbs.rArm.value" value="{{system.limbs.rArm.value}}"></div>
                    <div class="limb-input" style="top:230px; left:70px;"><input type="number" name="system.limbs.lLeg.value" value="{{system.limbs.lLeg.value}}"></div>
                    <div class="limb-input" style="top:230px; left:100px;"><input type="number" name="system.limbs.rLeg.value" value="{{system.limbs.rLeg.value}}"></div>
                </div>

                <!-- ВТОРИЧНЫЕ ХАРАКТЕРИСТИКИ (Moved here) -->
                <div class="secondary-stats-box">
                    <h3 style="font-size:0.9em; text-align:center; border:none; margin-bottom:5px;">ПАРАМЕТРЫ</h3>
                    <div class="sec-stat-row"><span class="sec-stat-label">Уклонение</span><span class="sec-stat-val">{{system.secondary.evasion.value}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Броня (Прир.)</span><span class="sec-stat-val">{{system.secondary.naturalAC.value}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Вес</span><span class="sec-stat-val">{{system.secondary.carryWeight.value}} / {{system.secondary.carryWeight.max}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Храбрость</span><span class="sec-stat-val">{{system.secondary.bravery.value}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Стойкость</span><span class="sec-stat-val">{{system.secondary.tenacity.value}}</span></div>
                    
                    <div class="sec-stat-row" style="margin-top:5px; border-top:1px dashed #555; padding-top:5px;">
                        <span class="sec-stat-label">Очки Улучшений</span>
                        <!-- Input for XP -->
                        <input type="number" name="system.secondary.xp.value" value="{{system.secondary.xp.value}}" style="width:40px; text-align:right; font-weight:bold;"/>
                    </div>
                </div>
            </div>

            <!-- COL 3: QUICK INVENTORY (Grid) -->
            <div class="col-right">
                <h3>БЫСТРЫЙ ДОСТУП</h3>
                <div style="font-size:0.8em; color:#666; margin-bottom:5px; font-style:italic;">
                    (ЛКМ - Использовать, ПКМ - Инфо)
                </div>
                
                <div class="inventory-grid">
                    <!-- ОРУЖИЕ (Только экипированное) -->
                    {{#each inventory.weapon.items as |item|}}
                        {{#if item.system.equipped}}
                        <div class="inv-slot item" data-item-id="{{item.id}}" title="{{item.name}} (Надето)">
                            <img src="{{item.img}}"/>
                            <span class="inv-qty" style="background:#2e7d32;">E</span> <!-- E for Equipped -->
                        </div>
                        {{/if}}
                    {{/each}}
                    
                    <!-- БРОНЯ (Только экипированная) -->
                    {{#each inventory.armor.items as |item|}}
                        {{#if item.system.equipped}}
                        <div class="inv-slot item" data-item-id="{{item.id}}" title="{{item.name}} (Надето)">
                            <img src="{{item.img}}"/>
                            <span class="inv-qty" style="background:#1565c0;">E</span>
                        </div>
                        {{/if}}
                    {{/each}}

                    <!-- МЕДИЦИНА (Вся) -->
                    {{#each inventory.medicine.items as |item|}}
                    <div class="inv-slot item" data-item-id="{{item.id}}" title="{{item.name}}">
                        <img src="{{item.img}}"/>
                        <span class="inv-qty">{{item.system.quantity}}</span>
                    </div>
                    {{/each}}
                    
                    <!-- Заполнители -->
                    <div class="inv-slot" style="opacity:0.3; border-style:dashed;"></div>
                    <div class="inv-slot" style="opacity:0.3; border-style:dashed;"></div>
                </div>

                <h3 style="margin-top:20px;">ЭФФЕКТЫ</h3>
                <div style="font-size:0.9em;">
                    {{#each effects as |effect|}}
                    <div class="flexrow" data-effect-id="{{effect.id}}" style="align-items:center; border-bottom:1px dotted #555; padding:2px;">
                        <img src="{{effect.img}}" width="16" height="16" style="margin-right:5px;"/> 
                        <span style="flex:1;">{{effect.name}}</span>
                        <a class="effect-control" data-action="delete" style="color:red; cursor:pointer;">×</a>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        {{/unless}}
    </div>

    <!-- TAB: FULL INVENTORY -->
    <div class="tab inventory" data-group="primary" data-tab="inventory">
        <div class="flexrow" style="margin-bottom:10px;">
            <a class="item-create" data-type="select" style="font-weight:bold; color:#0d47a1; cursor:pointer;">
                <i class="fas fa-plus-circle"></i> Добавить предмет
            </a>
        </div>
        
        <div class="full-inv-list">
            {{#each inventory as |section key|}}
                {{#if section.items.length}}
                <div style="font-weight:bold; border-bottom:2px solid #5d4037; margin-top:10px; background:rgba(0,0,0,0.05); padding:4px; color:#3e2723;">
                    {{section.label}}
                </div>
                
                <ol style="list-style:none; margin:0; padding:0;">
                    {{#each section.items as |item|}}
                    <li class="item" data-item-id="{{item.id}}" style="display:flex; align-items:center; padding:4px; border-bottom:1px dotted #ccc;">
                        <img src="{{item.img}}" width="24" height="24" style="border:1px solid #555; margin-right:8px;"/>
                        
                        <span style="flex:1; font-weight:bold; color:#1a1a1a;">
                            {{item.name}}
                            {{#if item.system.equipped}}
                                <span style="font-size:0.7em; color:#2e7d32; border:1px solid #2e7d32; padding:0 2px; border-radius:3px; margin-left:5px;">E</span>
                            {{/if}}
                        </span>
                        
                        <span style="margin-right:10px; font-weight:bold; color:#333;">x{{item.system.quantity}}</span>
                        
                        <div class="item-controls" style="display:flex; gap:5px;">
                            <!-- Кнопка Экипировки -->
                            {{#if (or (eq item.type "weapon") (eq item.type "armor"))}}
                                <a class="item-toggle" title="{{#if item.system.equipped}}Снять{{else}}Надеть{{/if}}">
                                    <i class="fas {{#if item.system.equipped}}fa-tshirt{{else}}fa-shirt{{/if}}" 
                                       style="{{#if item.system.equipped}}color:#2e7d32;{{else}}color:#aaa;{{/if}}"></i>
                                </a>
                            {{/if}}
                            
                            <!-- Кнопка Лечения (Медицина) -->
                            {{#if (eq item.type "medicine")}}
                                <a class="item-use" title="Лечить"><i class="fas fa-heartbeat" style="color:#c62828;"></i></a>
                            {{/if}}

                            {{#if (eq item.type "weapon")}}<a class="item-roll" title="Атака"><i class="fas fa-crosshairs" style="color:#333;"></i></a>{{/if}}
                            <a class="item-edit" title="Редактировать"><i class="fas fa-edit" style="color:#333;"></i></a>
                            <a class="item-delete" title="Удалить"><i class="fas fa-trash" style="color:#c62828;"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}
            {{/each}}
        </div>
    </div>

    <!-- TAB: EFFECTS -->
    <div class="tab effects" data-group="primary" data-tab="effects">
        <a class="effect-control" data-action="create">+ Новый эффект</a>
        {{#each effects as |effect|}}
        <li class="item flexrow" data-effect-id="{{effect.id}}" style="margin-top:5px; border:1px solid #999; padding:5px;">
            <img src="{{effect.img}}" width="24" height="24" style="margin-right:5px;"/>
            <span style="flex:1;">{{effect.name}}</span>
            <div class="effect-controls">
                <a class="effect-control" data-action="toggle"><i class="fas {{#if effect.disabled}}fa-toggle-off{{else}}fa-toggle-on{{/if}}"></i></a>
                <a class="effect-control" data-action="edit"><i class="fas fa-edit"></i></a>
                <a class="effect-control" data-action="delete"><i class="fas fa-trash"></i></a>
            </div>
        </li>
        {{/each}}
    </div>

  </section>
</form>