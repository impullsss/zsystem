<form class="{{cssClass}}" autocomplete="off">
  
  {{#if isDead}}<div class="dead-stamp">МЕРТВ</div>{{/if}}

  <!-- 1. HEADER -->
  <div class="clipboard-header">
      <div class="profile-img-container">
          <img src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
      </div>

      <div class="header-stats">
          <div style="border-bottom: 1px solid #333;">
              <input name="name" type="text" value="{{actor.name}}" placeholder="Имя Выжившего" style="font-size: 1.5em; border:none; width:100%;"/>
              {{#if (eq actor.type "survivor")}}
              <a class="char-manager-btn" title="Меню Персонажа (Прокачка)" style="font-size:1.2em; color:#333; cursor:pointer; margin-left:10px;">
                  <i class="fas fa-id-card"></i>
              </a>
              {{/if}}
          </div>

          <!-- HP Bar -->
          <div class="stat-bar">
              <span class="bar-label">HP</span>
              <div class="bar-track">
                  <div class="bar-fill hp" style="width: {{calculatePercentage system.resources.hp.value system.resources.hp.max}}%;"></div>
                  <div class="bar-inputs">
                      <!-- Ограничение max -->
                      <input type="number" name="system.resources.hp.value" value="{{system.resources.hp.value}}" 
                             min="0" max="{{system.resources.hp.max}}" title="Текущее"/>
                      <span style="color:#fff; font-weight:bold;">/</span>
                      <input type="number" value="{{system.resources.hp.max}}" disabled title="Максимум"/>
                  </div>
              </div>
          </div>

          <!-- AP Bar -->
          <div class="stat-bar" style="margin-bottom: 2px;"> <!-- margin для бонуса -->
              <span class="bar-label">AP</span>
              <div class="bar-track">
                  <div class="bar-fill ap" style="width: {{calculatePercentage system.resources.ap.value system.resources.ap.max}}%;"></div>
                  <div class="bar-inputs">
                      <!-- Ограничение max -->
                      <input type="number" name="system.resources.ap.value" value="{{system.resources.ap.value}}" 
                             min="0" max="{{system.resources.ap.max}}" title="Текущее"/>
                      <span style="color:#fff; font-weight:bold;">/</span>
                      <input type="number" value="{{system.resources.ap.max}}" disabled title="Максимум"/>
                  </div>
              </div>
              <a class="ap-reset" title="Сброс AP" style="margin-left:5px; color:#333;"><i class="fas fa-sync"></i></a>
          </div>

          <!-- AP BONUS FIELD (ВОЗВРАЩЕНО) -->
          <div style="display:flex; justify-content: flex-end; align-items: center; font-size: 0.8em; color:#555; margin-right: 25px;">
              <span>Бонус AP:</span>
              <input type="number" name="system.resources.ap.bonus" value="{{system.resources.ap.bonus}}" 
                     style="width: 30px; margin-left: 5px; text-align: center; border-bottom: 1px dotted #555; color: #000; font-weight: bold;"/>
          </div>

          <!-- Controls -->
          <div class="flexrow" style="gap:5px; margin-top:5px;">
              <button type="button" class="rest-btn" style="font-size:0.8em; padding:2px;"><i class="fas fa-bed"></i> Отдых</button>
              {{#if isProne}}<button type="button" class="stand-up-btn" style="font-size:0.8em; padding:2px; background:#ffcc80;"><i class="fas fa-child"></i> Встать</button>{{/if}}
          </div>
        {{#if isGM}}
                {{#if (or isDead (ne actor.type "survivor"))}}
                    <button type="button" class="convert-loot-btn" 
                            style="background: #5d4037; color: white; border: 1px solid #000; margin-top: 5px;">
                        <i class="fas fa-box-open"></i> Превратить в лут
                    </button>
                {{/if}}
            {{/if}}
          {{#if isGM}}
          <div class="gm-infection-box">
              <i class="fas fa-biohazard"></i> Инфекция:
              <input type="number" name="system.resources.infection.stage" value="{{system.resources.infection.stage}}" min="0" max="3" style="width:30px; border-bottom:1px solid red;"/>
              {{#if (gte system.resources.infection.stage 3)}}<a class="zombie-rise-btn" style="color:red; font-weight:bold;">ВОССТАТЬ!</a>{{/if}}
              <a class="full-heal-btn" title="Full Heal" style="margin-left:auto; color:green;"><i class="fas fa-heart"></i></a>
          </div>
          {{/if}}
      </div>
  </div>

  <!-- 2. TABS (Translated) -->
  <nav class="sheet-tabs tabs" data-group="primary">
    {{#unless (and isDead (not isGM))}}<a class="item" data-tab="main">Статус</a>{{/unless}}
    <a class="item" data-tab="perks">Черты</a>  <!-- НОВАЯ ВКЛАДКА -->
    <a class="item" data-tab="inventory">Рюкзак</a>
    {{#unless (and isDead (not isGM))}}<a class="item" data-tab="effects">Эффекты</a>{{/unless}}
  </nav>

  <!-- 3. BODY -->
  <section class="sheet-body">
    
    <!-- TAB: MAIN -->
    <div class="tab main" data-group="primary" data-tab="main">
        {{#unless (and isDead (not isGM))}}
        <div class="paper-grid">
            
            <!-- COL 1: ATTRIBUTES & SKILLS -->
            <div class="col-left">
                <!-- ATTRIBUTES -->
                <div>
                    <h3 style="display:flex; justify-content:space-between;">
                        ХАР-КИ
                        <span style="font-size:0.5em; color:#666; font-weight:normal; margin-top:5px;">(Потрачено: {{system.secondary.spentStats.value}})</span>
                    </h3>
                    
                    <div class="attr-grid attr-header">
                        <span>Название</span>
                        <span>База</span>
                        <span>Мод</span>
                        <span>Итог</span>
                    </div>

                    {{#each system.attributes as |attr key|}}
    <div class="attr-grid attr-row">
        <!-- Группа иконка + Название -->
        <label class="attr-label attr-roll" data-key="{{key}}" data-tooltip="ZSYSTEM.Tooltips.{{key}}">
    <span class="attr-icon"><i class="fas fa-dice-d10"></i></span>
    <span class="attr-name">{{lookup ../labels.attributes key}}</span>
</label>
        
        <!-- Базовое значение -->
        <div class="attr-base">
            {{#if ../isGM}}
                <input type="number" name="system.attributes.{{key}}.base" value="{{attr.base}}"/>
            {{else}}
                <span>{{attr.base}}</span>
            {{/if}}
        </div>

        <!-- Модификатор (как пилюля) -->
        <div class="attr-mod-wrapper">
            <span class="attr-mod-pill {{#if (gt attr.mod 0)}}pos{{else}}{{#if (lt attr.mod 0)}}neg{{/if}}{{/if}}">
                {{numberFormat attr.mod sign=true}}
            </span>
        </div>
        
        <!-- Финальный итог -->
        <div class="attr-total">
            {{attr.value}}
        </div>
    </div>
    {{/each}}
</div>

                <!-- SKILLS -->
<div style="margin-top:15px;">
    <h3 style="display:flex; justify-content:space-between;">
        НАВЫКИ
        <span style="font-size:0.5em; color:#666; font-weight:normal; margin-top:5px;">(XP: {{system.secondary.spentSkills.value}})</span>
    </h3>
    
    <div class="skill-grid skill-header">
        <span style="text-align: left;">Название</span>
        <span>База</span>
        <span></span> <!-- для + -->
        <span>Очки</span>
        <span></span> <!-- для + -->
        <span>Мод</span>
        <span></span> <!-- для = -->
        <span>Итог</span>
        <span></span> <!-- для кубика -->
    </div>

    <ul class="skills-list" style="border:none; padding:0; margin:0;">
    {{#each system.skills as |skill key|}}
    <li class="skill-grid skill-row" data-skill="{{key}}">
        {{!-- Название навыка теперь на своем месте с тултипом --}}
        <span class="skill-name" data-tooltip="ZSYSTEM.Tooltips.{{key}}">
            {{lookup ../labels.skills key}}
        </span>
        
        <span class="skill-base-text">{{skill.base}}</span>
        <span class="skill-op">+</span>
        
        <input class="skill-input {{#unless ../isGM}}locked-input{{/unless}}" 
               type="number" 
               name="system.skills.{{key}}.points" 
               value="{{skill.points}}" 
               {{#unless ../isGM}}readonly{{/unless}} />
        
        <span class="skill-op">+</span>
        
        <input class="skill-input skill-mod-val" type="number" name="system.skills.{{key}}.mod" value="{{skill.mod}}" placeholder="0"/>
        
        <span class="skill-op">=</span>
        
        <span class="skill-total-val">{{skill.value}}</span>
        
        <a class="skill-roll"><i class="fas fa-dice-d10"></i></a>
    </li>
    {{/each}}
</ul>
</div>

            </div>

            <!-- COL 2: DOLL & SECONDARY -->
            <div class="col-center">
                <h3 style="text-align:center;">СТАТУС</h3>
                
                <div class="body-chart-container">
                    <svg class="body-chart" viewBox="0 0 200 300">
                        <!-- ГОЛОВА -->
                        <g data-limb="head" class="limb-zone">
                            <title>Голова: {{system.limbs.head.value}} / {{system.limbs.head.max}}</title>
                            <circle cx="100" cy="40" r="25" class="limb-shape" 
                                    style="fill: {{getLimbColor system.limbs.head.value system.limbs.head.max}}"/>
                        </g>
                        
                        <!-- ТОРС -->
                        <g data-limb="torso" class="limb-zone">
                            <title>Торс: {{system.limbs.torso.value}} / {{system.limbs.torso.max}}</title>
                            <rect x="70" y="70" width="60" height="100" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.torso.value system.limbs.torso.max}}"/>
                        </g>
                        
                        <!-- ЛЕВАЯ РУКА -->
                        <g data-limb="lArm" class="limb-zone">
                            <title>Л.Рука: {{system.limbs.lArm.value}} / {{system.limbs.lArm.max}}</title>
                            <rect x="35" y="70" width="30" height="90" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.lArm.value system.limbs.lArm.max}}"/>
                        </g>
                        
                        <!-- ПРАВАЯ РУКА -->
                        <g data-limb="rArm" class="limb-zone">
                            <title>П.Рука: {{system.limbs.rArm.value}} / {{system.limbs.rArm.max}}</title>
                            <rect x="135" y="70" width="30" height="90" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.rArm.value system.limbs.rArm.max}}"/>
                        </g>
                        
                        <!-- ЛЕВАЯ НОГА -->
                        <g data-limb="lLeg" class="limb-zone">
                            <title>Л.Нога: {{system.limbs.lLeg.value}} / {{system.limbs.lLeg.max}}</title>
                            <rect x="70" y="175" width="28" height="110" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.lLeg.value system.limbs.lLeg.max}}"/>
                        </g>
                        
                        <!-- ПРАВАЯ НОГА -->
                        <g data-limb="rLeg" class="limb-zone">
                            <title>П.Нога: {{system.limbs.rLeg.value}} / {{system.limbs.rLeg.max}}</title>
                            <rect x="102" y="175" width="28" height="110" class="limb-shape"
                                  style="fill: {{getLimbColor system.limbs.rLeg.value system.limbs.rLeg.max}}"/>
                        </g>
                    </svg>
                    <!-- Inputs -->
                    <div class="limb-input" style="top:30px; left:85px;"><input type="number" name="system.limbs.head.value" value="{{system.limbs.head.value}}"></div>
                    <div class="limb-input" style="top:110px; left:85px;"><input type="number" name="system.limbs.torso.value" value="{{system.limbs.torso.value}}"></div>
                    <div class="limb-input" style="top:110px; left:40px;"><input type="number" name="system.limbs.lArm.value" value="{{system.limbs.lArm.value}}"></div>
                    <div class="limb-input" style="top:110px; left:140px;"><input type="number" name="system.limbs.rArm.value" value="{{system.limbs.rArm.value}}"></div>
                    <div class="limb-input" style="top:230px; left:70px;"><input type="number" name="system.limbs.lLeg.value" value="{{system.limbs.lLeg.value}}"></div>
                    <div class="limb-input" style="top:230px; left:100px;"><input type="number" name="system.limbs.rLeg.value" value="{{system.limbs.rLeg.value}}"></div>
                </div>

                <!-- ВТОРИЧНЫЕ ХАРАКТЕРИСТИКИ (Moved here) -->
                <div class="secondary-stats-box">
                    <h3 style="font-size:0.9em; text-align:center; border:none; margin-bottom:5px;">ПАРАМЕТРЫ</h3>
                    <div class="sec-stat-row"><span class="sec-stat-label">Уклонение</span><span class="sec-stat-val">{{system.secondary.evasion.value}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Броня (Прир.)</span><span class="sec-stat-val">{{system.secondary.naturalAC.value}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Вес</span><span class="sec-stat-val">{{system.secondary.carryWeight.value}} / {{system.secondary.carryWeight.max}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Храбрость</span><span class="sec-stat-val">{{system.secondary.bravery.value}}</span></div>
                    <div class="sec-stat-row"><span class="sec-stat-label">Стойкость</span><span class="sec-stat-val">{{system.secondary.tenacity.value}}</span></div>
                    
                    <!-- ВОЗВРАЩЕНО: XP и PP -->
                    <div style="margin-top:10px; border-top:1px dashed #777; padding-top:5px;">
                        
                        <!-- Опыт (SP) -->
                        <div class="sec-stat-row" title="Потрачено всего: {{system.secondary.xp.spent}}">
                            <span class="sec-stat-label" style="color:#1b5e20;">Опыт (SP)</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                {{#if isGM}}
                                    <input type="number" name="system.secondary.xp.value" value="{{system.secondary.xp.value}}" style="width:40px; text-align:right; font-weight:bold;"/>
                                {{else}}
                                    <span class="sec-stat-val" style="color:#1b5e20;">{{system.secondary.xp.value}}</span>
                                {{/if}}
                            </div>
                        </div>

                        <!-- Прогресс бар до Perk Point -->
                        <div style="width:100%; height:4px; background:#ccc; margin-bottom:5px; position:relative;" title="Прогресс до следующего PP">
                            <!-- Считаем остаток от деления на 25 -->
                            <div style="height:100%; background:#ffab91; width:{{calculatePercentage (mod system.secondary.xp.spent 25) 25}}%;"></div>
                        </div>

                        <!-- Perk Points -->
                        <div class="sec-stat-row">
                            <span class="sec-stat-label" style="color:#d84315;">Perk Points</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                {{#if isGM}}
                                    <input type="number" name="system.secondary.perkPoints.value" value="{{system.secondary.perkPoints.value}}" style="width:40px; text-align:right; font-weight:bold;"/>
                                {{else}}
                                    <span class="sec-stat-val" style="color:#d84315;">{{system.secondary.perkPoints.value}}</span>
                                {{/if}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COL 3: QUICK INVENTORY (Grid) -->
            <div class="col-right">
                <h3>БЫСТРЫЙ ДОСТУП</h3>
                <div style="font-size:0.8em; color:#666; margin-bottom:5px; font-style:italic;">
                    (ЛКМ - Использовать, ПКМ - Инфо)
                </div>
                
                <div class="inventory-grid">
    {{#each inventory as |section|}}
        {{#each section.items as |item|}}
            {{#if (or item.system.equipped item.system.favorite (eq item.type "medicine"))}}
            <div class="inv-slot item" data-item-id="{{item.id}}" title="{{item.name}}">
                <img src="{{item.img}}"/>
                
                <div class="inv-qty">
                    {{#if item.system.equipped}}
                        <span style="background:#2e7d32; padding: 0 4px;">E</span>
                    {{else if item.system.favorite}}
                        <span style="background:#fbc02d; color:#000; padding: 0 2px;"><i class="fas fa-star" style="font-size:0.7em;"></i></span>
                    {{/if}}
                    
                    {{#if (gt item.system.quantity 1)}}
                        <span style="background:rgba(0,0,0,0.5); padding: 0 4px;">{{item.system.quantity}}</span>
                    {{/if}}
                </div>
            </div>
            {{/if}}
        {{/each}}
    {{/each}}
    
    <!-- Заполнители -->
    <div class="inv-slot" style="opacity:0.1; border-style:dashed;"></div>
    <div class="inv-slot" style="opacity:0.1; border-style:dashed;"></div>
</div>

                <h3 style="margin-top:20px;">ЭФФЕКТЫ</h3>
                <div style="font-size:0.9em;">
                    {{#each effects as |effect|}}
                    <div class="flexrow" data-effect-id="{{effect.id}}" style="align-items:center; border-bottom:1px dotted #555; padding:2px;">
                        <img src="{{effect.img}}" width="16" height="16" style="margin-right:5px;"/> 
                        <span style="flex:1;">{{effect.name}}</span>
                        <a class="effect-control" data-action="delete" style="color:red; cursor:pointer;">×</a>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>
        {{/unless}}
    </div>

    <!-- TAB: FULL INVENTORY -->
    <div class="tab inventory" data-group="primary" data-tab="inventory">
        <div class="flexrow" style="margin-bottom:10px;">
            <a class="item-create" data-type="select" style="font-weight:bold; color:#0d47a1; cursor:pointer;">
                <i class="fas fa-plus-circle"></i> Добавить предмет
            </a>
        </div>
        
        <div class="full-inv-list">
            {{#each inventory as |section key|}}
                {{#if section.items.length}}
                <div style="font-weight:bold; border-bottom:2px solid #5d4037; margin-top:10px; background:rgba(0,0,0,0.05); padding:4px; color:#3e2723;">
                    {{section.label}}
                </div>
                
                <ol style="list-style:none; margin:0; padding:0;">
                    {{#each section.items as |item|}}
                    <li class="item" data-item-id="{{item.id}}" style="display:flex; align-items:center; padding:4px; border-bottom:1px dotted #ccc;">
                        <img src="{{item.img}}" width="24" height="24" style="border:1px solid #555; margin-right:8px;"/>
                        
                        <span style="flex:1; font-weight:bold; color:#1a1a1a;">
                            {{item.name}}
                            {{#if item.system.equipped}}
                                <span style="font-size:0.7em; color:#2e7d32; border:1px solid #2e7d32; padding:0 2px; border-radius:3px; margin-left:5px;">E</span>
                            {{/if}}
                        </span>
                        
                        <span style="margin-right:10px; font-weight:bold; color:#333;">x{{item.system.quantity}}</span>
                        
                        <div class="item-controls" style="display:flex; gap:5px;">
                            <!-- Кнопка Экипировки -->
                            <a class="item-favorite" title="В быстрый доступ">
                            <i class="{{#if item.system.favorite}}fas fa-star{{else}}far fa-star{{/if}}" 
                             style="{{#if item.system.favorite}}color:#fbc02d;{{else}}color:#aaa;{{/if}}"></i>
                             </a>
                            {{#if (or (eq item.type "weapon") (eq item.type "armor"))}}
                                <a class="item-toggle" title="{{#if item.system.equipped}}Снять{{else}}Надеть{{/if}}">
                                    <i class="fas {{#if item.system.equipped}}fa-tshirt{{else}}fa-shirt{{/if}}" 
                                       style="{{#if item.system.equipped}}color:#2e7d32;{{else}}color:#aaa;{{/if}}"></i>
                                </a>
                            {{/if}}
                            
                            <!-- Кнопка Лечения (Медицина) -->
                            {{#if (eq item.type "medicine")}}
                                <a class="item-use" title="Лечить"><i class="fas fa-heartbeat" style="color:#c62828;"></i></a>
                            {{/if}}
                            <!-- Кнопка Перезарядки (ЕСЛИ ЕСТЬ AMMO TYPE) -->
                            {{#if (and (eq item.type "weapon") item.system.ammoType)}}
                                <a class="item-reload" title="Перезарядка"><i class="fas fa-sync" style="color:#1565c0;"></i></a>
                            {{/if}}

                            {{#if (eq item.type "weapon")}}<a class="item-roll" title="Атака"><i class="fas fa-crosshairs" style="color:#333;"></i></a>{{/if}}
                            <a class="item-edit" title="Редактировать"><i class="fas fa-edit" style="color:#333;"></i></a>
                            <a class="item-delete" title="Удалить"><i class="fas fa-trash" style="color:#c62828;"></i></a>
                        </div>
                    </li>
                    {{/each}}
                </ol>
                {{/if}}
            {{/each}}
        </div>
    </div>

    <!-- TAB: PERKS / FEATURES -->
    <div class="tab perks" data-group="primary" data-tab="perks">
        <div class="perk-list">
            <!-- Заголовок -->
            <div class="flexrow" style="background:#3e2723; color:#fff; padding:5px; font-weight:bold; margin-bottom:5px;">
                <div style="flex:1;">Название</div>
                <div style="flex:2;">Описание</div>
                <div style="width:50px; text-align:center;">PP</div>
                {{#if isGM}}<div style="width:40px;"></div>{{/if}}
            </div>

            {{#each perks as |perk|}}
            <div class="item flexrow" data-item-id="{{perk.id}}" style="border-bottom:1px solid #ccc; padding:5px; align-items:flex-start; background:rgba(255,255,255,0.3);">
                
                <!-- Иконка и Имя -->
                <div style="flex:1; display:flex; align-items:center; gap:5px;">
                    <img src="{{perk.img}}" width="24" height="24" style="border:1px solid #555;"/>
                    <div>
                        <div style="font-weight:bold;">{{perk.name}}</div>
                        <div style="font-size:0.8em; color:#555; font-style:italic;">
                            {{#if (eq perk.system.subtype "background")}}Предыстория{{else}}Перк{{/if}}
                        </div>
                    </div>
                </div>

                <!-- Описание -->
                <div style="flex:2; font-size:0.9em; color:#333;">
                    {{{perk.system.description}}}
                </div>

                <!-- Стоимость -->
                <div style="width:50px; text-align:center; font-weight:bold; color:#d84315;">
                    {{#if perk.system.xpCost}}{{perk.system.xpCost}}{{else}}-{{/if}}
                </div>

                <!-- Контролы -->
                <div class="item-controls" style="width:40px; text-align:right;">
                    <a class="item-edit"><i class="fas fa-edit"></i></a>
                    {{#if ../isGM}}<a class="item-delete" style="color:red;"><i class="fas fa-trash"></i></a>{{/if}}
                </div>
            </div>
            {{/each}}
            
            {{#unless perks}}
            <p style="text-align:center; color:#777; margin-top:20px;">Нет особенностей.</p>
            {{/unless}}
        </div>
    </div>

    <!-- TAB: EFFECTS -->
    <div class="tab effects" data-group="primary" data-tab="effects">
        <a class="effect-control" data-action="create">+ Новый эффект</a>
        {{#each effects as |effect|}}
        <li class="item flexrow" data-effect-id="{{effect.id}}" style="margin-top:5px; border:1px solid #999; padding:5px;">
            <img src="{{effect.img}}" width="24" height="24" style="margin-right:5px;"/>
            <span style="flex:1;">{{effect.name}}</span>
            <div class="effect-controls">
                <a class="effect-control" data-action="toggle"><i class="fas {{#if effect.disabled}}fa-toggle-off{{else}}fa-toggle-on{{/if}}"></i></a>
                <a class="effect-control" data-action="edit"><i class="fas fa-edit"></i></a>
                <a class="effect-control" data-action="delete"><i class="fas fa-trash"></i></a>
            </div>
        </li>
        {{/each}}
    </div>

  </section>
</form>