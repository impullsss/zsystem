<form class="{{cssClass}}" autocomplete="off">
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
    <div class="header-fields">
      <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Имя"/></h1>
      
      <div class="resources grid grid-2col">
        <!-- HP -->
        <div class="resource">
          <label class="resource-label">HP</label>
          <div class="resource-content">
             {{#if isDead}}
                <span style="color:red; font-weight:bold;">МЕРТВ</span>
             {{else}}
                <input type="number" name="system.resources.hp.value" value="{{system.resources.hp.value}}"/>
                <span> / </span>
                <input type="number" name="system.resources.hp.max" value="{{system.resources.hp.max}}" disabled/>
             {{/if}}
          </div>
        </div>
        
        <!-- AP (С полем бонуса) -->
        <div class="resource">
          <label class="resource-label">ОД (AP)</label>
          <div class="resource-content">
            <input type="number" name="system.resources.ap.value" value="{{system.resources.ap.value}}"/>
            <span> / </span>
            <input type="number" name="system.resources.ap.max" value="{{system.resources.ap.max}}" disabled/>
             <a class="ap-reset" title="Восстановить AP"><i class="fas fa-sync"></i></a>
          </div>
          
          <div class="ap-bonus-label">
              Бонус: <input type="number" class="ap-bonus-input" name="system.resources.ap.bonus" value="{{system.resources.ap.bonus}}"/>
          </div>
        </div>
      </div>

      <!-- GM SECRET SECTION -->
      {{#if isGM}}
      {{#unless (eq actor.type "zombie")}} <!-- ПРОВЕРКА ТИПА: Скрываем для Зомби -->
      <div style="margin-top: 5px; padding: 5px; border: 1px dashed #ff0000; background: rgba(0, 0, 0, 0.2); border-radius: 5px;">
          <div style="font-weight: bold; color: #ff6666; font-size: 0.9em; text-align: center;">
              <i class="fas fa-user-secret"></i> GM: Инфекция
          </div>
          <div class="flexrow" style="align-items: center; justify-content: center; gap: 10px;">
              <input type="number" name="system.resources.infection.stage" value="{{system.resources.infection.stage}}" min="0" max="3" 
                     style="width: 40px; text-align: center; background: #330000; color: white; border: 1px solid red;">
              
              {{#if (gte system.resources.infection.stage 3)}}
                  <a class="zombie-rise-btn" style="color: red; border: 1px solid red; background: black;">ВОССТАТЬ!</a>
              {{/if}}
          </div>
      </div>
      {{/unless}}
      {{/if}}

      <!-- Кнопки действий -->
      <div class="action-buttons flexrow" style="margin-top:5px; gap:5px;">
          <button type="button" class="rest-btn"><i class="fas fa-bed"></i> Отдых</button>
          {{#if isProne}}
            <button type="button" class="stand-up-btn" style="background:#ffcc80; color:black;"><i class="fas fa-child"></i> Встать</button>
          {{/if}}
          {{#if isGM}} <!-- ТОЛЬКО ДЛЯ GM -->
            {{#if (gt system.resources.infection.stage 0)}}
            <div style="background: #3a0000; border: 2px solid red; color: red; text-align: center; font-weight: bold; margin-top: 5px; padding: 4px; border-radius: 4px; animation: pulse-injury 2s infinite;">
                <i class="fas fa-biohazard"></i> ИНФЕКЦИЯ: СТАДИЯ {{system.resources.infection.stage}} <i class="fas fa-biohazard"></i>
            </div>
            {{/if}}
          {{/if}}
      </div>
    </div>

    <div class="header-doll">
        <div class="body-chart-container">
            <svg class="body-chart" viewBox="0 0 200 300" xmlns="http://www.w3.org/2000/svg">
                <g class="limb-zone" data-limb="head"><circle cx="100" cy="30" r="25" class="limb-shape"/><text x="100" y="35" text-anchor="middle" class="limb-label">HEAD</text></g>
                <g class="limb-zone" data-limb="lArm"><rect x="30" y="60" width="35" height="100" rx="10" class="limb-shape"/><text x="47" y="110" text-anchor="middle" class="limb-label">L.ARM</text></g>
                <g class="limb-zone" data-limb="rArm"><rect x="135" y="60" width="35" height="100" rx="10" class="limb-shape"/><text x="152" y="110" text-anchor="middle" class="limb-label">R.ARM</text></g>
                <g class="limb-zone" data-limb="torso"><rect x="70" y="60" width="60" height="110" rx="5" class="limb-shape"/><text x="100" y="115" text-anchor="middle" class="limb-label">TORSO</text></g>
                <g class="limb-zone" data-limb="lLeg"><rect x="70" y="175" width="28" height="120" rx="5" class="limb-shape"/><text x="84" y="240" text-anchor="middle" class="limb-label">L.LEG</text></g>
                <g class="limb-zone" data-limb="rLeg"><rect x="102" y="175" width="28" height="120" rx="5" class="limb-shape"/><text x="116" y="240" text-anchor="middle" class="limb-label">R.LEG</text></g>
            </svg>
            <div class="limb-input" style="top: 20px; left: 70px;"><input type="number" name="system.limbs.head.value" value="{{system.limbs.head.value}}"><span>/{{system.limbs.head.max}}</span></div>
            <div class="limb-input" style="top: 100px; left: 70px;"><input type="number" name="system.limbs.torso.value" value="{{system.limbs.torso.value}}"><span>/{{system.limbs.torso.max}}</span></div>
            <div class="limb-input" style="top: 100px; left: 17px;"><input type="number" name="system.limbs.lArm.value" value="{{system.limbs.lArm.value}}"><span>/{{system.limbs.lArm.max}}</span></div>
            <div class="limb-input" style="top: 100px; left: 123px;"><input type="number" name="system.limbs.rArm.value" value="{{system.limbs.rArm.value}}"><span>/{{system.limbs.rArm.max}}</span></div>
            <div class="limb-input" style="top: 230px; left: 53px;"><input type="number" name="system.limbs.lLeg.value" value="{{system.limbs.lLeg.value}}"><span>/{{system.limbs.lLeg.max}}</span></div>
            <div class="limb-input" style="top: 230px; left: 87px;"><input type="number" name="system.limbs.rLeg.value" value="{{system.limbs.rLeg.value}}"><span>/{{system.limbs.rLeg.max}}</span></div>
        </div>
    </div>
  </header>

  <nav class="sheet-tabs tabs" data-group="primary">
    <!-- Скрываем "Главная", если персонаж мертв и смотрит игрок -->
    {{#unless (and isDead (not isGM))}}
    <a class="item" data-tab="attributes">Главная</a>
    {{/unless}}
    
    <a class="item" data-tab="inventory">Инвентарь</a>
    
    <!-- Скрываем "Эффекты", если персонаж мертв и смотрит игрок -->
    {{#unless (and isDead (not isGM))}}
    <a class="item" data-tab="effects">Эффекты</a>
    {{/unless}}
  </nav>

  <section class="sheet-body">
    
    <!-- TAB: ATTRIBUTES -->
    <div class="tab attributes" data-group="primary" data-tab="attributes">
      {{#unless (and isDead (not isGM))}}
      <div class="main-grid">
        
        <!-- ХАРАКТЕРИСТИКИ -->
        <div class="stats-panel">
          <h3>Характеристики <span style="font-size:0.6em; color:#888;">(Потрачено: {{system.secondary.spentStats.value}})</span></h3>
          <div class="flexrow stat-header" style="font-size:0.8em; color:#666; margin-bottom:2px;">
              <span style="flex:2"></span>
              <span style="flex:1; text-align:center;">База</span>
              <span style="flex:1; text-align:center;">Мод</span>
              <span style="flex:1; text-align:center;">Итог</span>
          </div>

          <div class="stat-row flexrow" style="align-items:center; margin-bottom:2px;">
            <label style="flex:2; font-weight:bold;">СИЛА</label>
            <input type="number" name="system.attributes.str.base" value="{{system.attributes.str.base}}" min="1" max="10" style="flex:1; text-align:center;"/>
            <span class="stat-mod" style="flex:1; text-align:center;">{{#if (gt system.attributes.str.mod 0)}}+{{/if}}{{system.attributes.str.mod}}</span>
            <span class="stat-total value-box" style="flex:1; text-align:center; font-weight:bold;">{{system.attributes.str.value}}</span>
          </div>
          <div class="stat-row flexrow" style="align-items:center; margin-bottom:2px;">
            <label style="flex:2; font-weight:bold;">ЛОВКОСТЬ</label>
            <input type="number" name="system.attributes.agi.base" value="{{system.attributes.agi.base}}" min="1" max="10" style="flex:1; text-align:center;"/>
            <span class="stat-mod" style="flex:1; text-align:center;">{{#if (gt system.attributes.agi.mod 0)}}+{{/if}}{{system.attributes.agi.mod}}</span>
            <span class="stat-total value-box" style="flex:1; text-align:center; font-weight:bold;">{{system.attributes.agi.value}}</span>
          </div>
           <div class="stat-row flexrow" style="align-items:center; margin-bottom:2px;">
            <label style="flex:2; font-weight:bold;">ЖИВУЧЕСТЬ</label>
            <input type="number" name="system.attributes.vig.base" value="{{system.attributes.vig.base}}" min="1" max="10" style="flex:1; text-align:center;"/>
            <span class="stat-mod" style="flex:1; text-align:center;">{{#if (gt system.attributes.vig.mod 0)}}+{{/if}}{{system.attributes.vig.mod}}</span>
            <span class="stat-total value-box" style="flex:1; text-align:center; font-weight:bold;">{{system.attributes.vig.value}}</span>
          </div>
           <div class="stat-row flexrow" style="align-items:center; margin-bottom:2px;">
            <label style="flex:2; font-weight:bold;">ВОСПРИЯТИЕ</label>
            <input type="number" name="system.attributes.per.base" value="{{system.attributes.per.base}}" min="1" max="10" style="flex:1; text-align:center;"/>
            <span class="stat-mod" style="flex:1; text-align:center;">{{#if (gt system.attributes.per.mod 0)}}+{{/if}}{{system.attributes.per.mod}}</span>
            <span class="stat-total value-box" style="flex:1; text-align:center; font-weight:bold;">{{system.attributes.per.value}}</span>
          </div>
           <div class="stat-row flexrow" style="align-items:center; margin-bottom:2px;">
            <label style="flex:2; font-weight:bold;">ИНТЕЛЛЕКТ</label>
            <input type="number" name="system.attributes.int.base" value="{{system.attributes.int.base}}" min="1" max="10" style="flex:1; text-align:center;"/>
            <span class="stat-mod" style="flex:1; text-align:center;">{{#if (gt system.attributes.int.mod 0)}}+{{/if}}{{system.attributes.int.mod}}</span>
            <span class="stat-total value-box" style="flex:1; text-align:center; font-weight:bold;">{{system.attributes.int.value}}</span>
          </div>
           <div class="stat-row flexrow" style="align-items:center; margin-bottom:2px;">
            <label style="flex:2; font-weight:bold;">ХАРИЗМА</label>
            <input type="number" name="system.attributes.cha.base" value="{{system.attributes.cha.base}}" min="1" max="10" style="flex:1; text-align:center;"/>
            <span class="stat-mod" style="flex:1; text-align:center;">{{#if (gt system.attributes.cha.mod 0)}}+{{/if}}{{system.attributes.cha.mod}}</span>
            <span class="stat-total value-box" style="flex:1; text-align:center; font-weight:bold;">{{system.attributes.cha.value}}</span>
          </div>

          <hr>
          <h3>Вторичные</h3>
          <div class="stat-row flexrow"><label>Уклонение</label><span class="value-box">{{system.secondary.evasion.value}}</span></div>
          <div class="stat-row flexrow"><label>Природная Броня</label><span class="value-box">{{system.secondary.naturalAC.value}}</span></div>
          <div class="stat-row flexrow"><label>Переносимый вес</label><span class="value-box">{{system.secondary.carryWeight.value}} / {{system.secondary.carryWeight.max}}</span></div>
          <div class="stat-row flexrow"><label>Храбрость</label><span class="value-box">{{system.secondary.bravery.value}}</span></div>
          <div class="stat-row flexrow"><label>Стойкость</label><span class="value-box">{{system.secondary.tenacity.value}}</span></div>
          <div class="stat-row flexrow">
              <label>Очки Улучшения (XP)</label>
              <input type="number" name="system.secondary.xp.value" value="{{system.secondary.xp.value}}" style="width:50px; text-align:center; background:rgba(255,255,255,0.1); color:black; border:1px solid #555;"/>
          </div>
        </div>

        <div class="body-panel"></div>

        <!-- НАВЫКИ -->
        <div class="skills-panel">
          <h3 style="border-bottom:1px solid #ccc; margin-bottom:5px;">
              Навыки <span style="font-size:0.6em; color:#888; float:right;">Потрачено: {{system.secondary.spentSkills.value}}</span>
          </h3>
          <ul class="skills-list">
            <li class="skill-row flexrow" data-skill="melee"><span class="skill-name">Ближний бой</span><span class="skill-base">{{system.skills.melee.base}}</span><input class="skill-points" type="number" name="system.skills.melee.points" value="{{system.skills.melee.points}}"/><span class="skill-total">{{system.skills.melee.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="ranged"><span class="skill-name">Стрельба</span><span class="skill-base">{{system.skills.ranged.base}}</span><input class="skill-points" type="number" name="system.skills.ranged.points" value="{{system.skills.ranged.points}}"/><span class="skill-total">{{system.skills.ranged.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="science"><span class="skill-name">Наука</span><span class="skill-base">{{system.skills.science.base}}</span><input class="skill-points" type="number" name="system.skills.science.points" value="{{system.skills.science.points}}"/><span class="skill-total">{{system.skills.science.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="mechanical"><span class="skill-name">Механика</span><span class="skill-base">{{system.skills.mechanical.base}}</span><input class="skill-points" type="number" name="system.skills.mechanical.points" value="{{system.skills.mechanical.points}}"/><span class="skill-total">{{system.skills.mechanical.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="medical"><span class="skill-name">Медицина</span><span class="skill-base">{{system.skills.medical.base}}</span><input class="skill-points" type="number" name="system.skills.medical.points" value="{{system.skills.medical.points}}"/><span class="skill-total">{{system.skills.medical.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="diplomacy"><span class="skill-name">Дипломатия</span><span class="skill-base">{{system.skills.diplomacy.base}}</span><input class="skill-points" type="number" name="system.skills.diplomacy.points" value="{{system.skills.diplomacy.points}}"/><span class="skill-total">{{system.skills.diplomacy.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="leadership"><span class="skill-name">Лидерство</span><span class="skill-base">{{system.skills.leadership.base}}</span><input class="skill-points" type="number" name="system.skills.leadership.points" value="{{system.skills.leadership.points}}"/><span class="skill-total">{{system.skills.leadership.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="survival"><span class="skill-name">Выживание</span><span class="skill-base">{{system.skills.survival.base}}</span><input class="skill-points" type="number" name="system.skills.survival.points" value="{{system.skills.survival.points}}"/><span class="skill-total">{{system.skills.survival.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="athletics"><span class="skill-name">Атлетика</span><span class="skill-base">{{system.skills.athletics.base}}</span><input class="skill-points" type="number" name="system.skills.athletics.points" value="{{system.skills.athletics.points}}"/><span class="skill-total">{{system.skills.athletics.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
            <li class="skill-row flexrow" data-skill="stealth"><span class="skill-name">Скрытность</span><span class="skill-base">{{system.skills.stealth.base}}</span><input class="skill-points" type="number" name="system.skills.stealth.points" value="{{system.skills.stealth.points}}"/><span class="skill-total">{{system.skills.stealth.value}}</span><a class="skill-roll"><i class="fas fa-dice-d20"></i></a></li>
          </ul>
        </div>
      </div>
      {{/unless}}
    </div>

    <!-- INVENTORY -->
    <div class="tab inventory" data-group="primary" data-tab="inventory">
      <!-- Показываем кнопки создания ТОЛЬКО владельцу или GM. Если труп - скрываем -->
      {{#if (or isGM actor.isOwner)}}
      <div class="inventory-controls flexrow" style="margin-bottom:10px;">
        <a class="item-create" data-type="weapon"><i class="fas fa-plus"></i> Оружие</a>
        <a class="item-create" data-type="ammo"><i class="fas fa-plus"></i> Патроны</a>
        <a class="item-create" data-type="armor"><i class="fas fa-plus"></i> Броня</a>
        <a class="item-create" data-type="medicine"><i class="fas fa-plus"></i> Медицина</a>
        <a class="item-create" data-type="food"><i class="fas fa-plus"></i> Еда</a>
        <a class="item-create" data-type="misc"><i class="fas fa-plus"></i> Разное</a>
      </div>
      {{else}}
      <div style="text-align:center; color:#aaa; font-style:italic; margin-bottom:5px; border-bottom: 1px dashed #555; padding-bottom: 5px;">
         <i class="fas fa-search"></i> Режим осмотра (Looting)
      </div>
      {{/if}}

      <ol class="items-list">
        {{#each inventory as |section key|}}
          <li class="item-header flexrow" style="background:#ddd; padding:5px; font-weight:bold;">
            <h3 style="margin:0;">{{section.label}}</h3>
            <div style="text-align:center; width:50px;">Вес</div>
            <div style="text-align:center; width:50px;">Кол.</div>
            <div style="width:90px;"></div>
          </li>
          <ol class="item-list">
          {{#each section.items as |item|}}
            <li class="item flexrow" data-item-id="{{item.id}}" style="padding:5px; border-bottom:1px solid #eee; align-items:center;">
              <div class="item-image" style="margin-right:5px;"><img src="{{item.img}}" width="24" height="24"/></div>
              <h4 class="item-name item-edit clickable" style="margin:0;">{{item.name}}</h4>
              <div style="text-align:center; width:50px;">{{item.system.weight}}</div>
              <div style="text-align:center; width:50px;">{{item.system.quantity}}</div>
              
              <div class="item-controls" style="width:90px; text-align:right;">
                {{#if (or (eq item.type "weapon") (eq item.type "armor"))}}
                    <a class="item-toggle"><i class="fas {{#if item.system.equipped}}fa-tshirt{{else}}fa-shirt{{/if}}" style="{{#if item.system.equipped}}color:green;{{else}}color:grey;{{/if}}"></i></a>
                {{/if}}
                {{#if (eq item.type "weapon")}}
                    <a class="item-roll"><i class="fas fa-crosshairs"></i></a>
                    <a class="item-reload"><i class="fas fa-sync"></i></a>
                {{/if}}
                {{#if (eq item.type "medicine")}}
                    <a class="item-use" title="Лечиться"><i class="fas fa-heartbeat"></i></a>
                {{/if}}
                <a class="item-edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete"><i class="fas fa-trash"></i></a>
              </div>
            </li>
          {{/each}}
          </ol>
        {{/each}}
      </ol>
    </div>

    <!-- TAB: EFFECTS -->
    <div class="tab effects" data-group="primary" data-tab="effects">
        {{#unless (and isDead (not isGM))}}
        <div class="effects-header flexrow" style="margin-bottom:10px;">
            <h3>Активные Эффекты</h3>
            <a class="effect-control" data-action="create"><i class="fas fa-plus"></i></a>
        </div>
        <ul class="effects-list">
            {{#each effects as |effect|}}
            <li class="effect-item flexrow" data-effect-id="{{effect.id}}">
                <img src="{{effect.img}}" width="24" height="24"/>
                <div style="flex:1;">{{effect.name}}</div>
                <div class="effect-controls">
                <a class="effect-control" data-action="toggle"><i class="fas {{#if effect.disabled}}fa-toggle-off{{else}}fa-toggle-on{{/if}}"></i></a>
                <a class="effect-control" data-action="edit"><i class="fas fa-edit"></i></a>
                <a class="effect-control" data-action="delete"><i class="fas fa-trash"></i></a>
                </div>
            </li>
            {{/each}}
        </ul>
        {{/unless}}
    </div>
  </section>
</form>